<!DOCTYPE html>
<html>
<head>
  <title>CsoundNotebook</title>
  <%= stylesheet_link_tag    "application", media: "all", "data-turbolinks-track" => true %>
  <%= javascript_include_tag "application", "data-turbolinks-track" => true %>
  <script type="text/javascript" src="csound.js"></script>

 <script type="text/javascript">
 // called by csound.js
 function moduleDidLoad() {

 }
 function attachListeners() { 
  document.getElementById('playButton').
       addEventListener('click', togglePlay);
   document.getElementById('files').
      addEventListener('change', handleFileSelect, false);
 }

 var count = 0;
 function handleMessage(message) {
        var element = document.getElementById('console');
        element.value += message.data;
        element.scrollTop = 99999; // focus on bottom
        count += 1;
        if(count == 1000) {
           element.value = ' ';
           count = 0;
        }
  }


 var playing = false;
 var started = false;
 var loaded = false;
 var fname;

 function togglePlay(){
  if(loaded) {
  if(!playing) {
  if(started) csound.Play();
  else {
   csound.PlayCsd("local/" + fname)
   started = true;
  }
  document.getElementById('playButton').innerText = "Pause";
  playing = true;
  } else {
  csound.Pause()
  document.getElementById('playButton').innerText ="Play";
  playing = false;
  }
}
}

function handleFileSelect(evt) {
   if(!loaded) {
    var files = evt.target.files; 
    var f = files[0];
    var objectURL = window.webkitURL.createObjectURL(f);
    csound.CopyUrlToLocal(objectURL, f.name);
    fname = f.name;
    loaded = true;
   } else {
   csound.updateStatus("to load a new CSD, first refresh page!")
  }
}
 
</script>

  <%= csrf_meta_tags %>
</head>
<body role="document">

<div class="navbar navbar-inverse" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">Csound Notebook</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li><%= link_to "About", :about %></li>
        <li><%= link_to "My Notebook", :controller => :pages, action: :notebook %></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
    <% if current_user %>
      <li><%= link_to "Edit Profile", edit_user_path(current_user.id) %></li>
      <li><%= link_to "Logout", :logout, method: :post %></li>
  <% else %>
    <li><%= link_to "Register", new_user_path %></li>
    <li><%= link_to "Login", :login %></li>
  <% end %>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>
<div>
  <p id="notice"><%= flash[:notice] %></p>
  <p id="alert"><%= flash[:alert] %></p>
</div>

<div class="container">
<%= yield %>
</div>

</body>
</html>
